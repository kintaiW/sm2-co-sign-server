# SM2 协同签名服务 API 文档

## 1. 接口概述

本文档描述了 SM2 协同签名服务的 RESTful API 接口，包括业务接口和管理接口。所有接口均使用 JSON 格式的请求和响应，二进制数据使用 Base64 编码传输。

### 1.1 接口前缀

- 业务接口：`/api`
- 管理接口：`/mapi`

### 1.2 统一响应格式

```json
{
  "code": 0,           // 0=成功，非0=错误码
  "message": "success", // 消息
  "data": {}           // 响应数据
}
```

### 1.3 认证方式

- 所有需要认证的接口使用 Bearer Token 认证
- Token 在登录成功后获取

## 2. 业务接口

### 2.1 用户注册

**POST /api/register**

用户注册并初始化密钥对生成。

**请求参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| p1 | string | 是 | 客户端生成的 P1 点（Base64 编码） |

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| userId | string | 用户ID |
| p2 | string | 服务端生成的 P2 点（Base64 编码） |
| pa | string | 协同公钥 Pa（Base64 编码） |

**示例**

```json
// 请求
{
  "username": "test",
  "password": "123456",
  "p1": "Base64编码的P1点"
}

// 响应
{
  "code": 0,
  "message": "success",
  "data": {
    "userId": "uuid",
    "p2": "Base64编码的P2点",
    "pa": "Base64编码的Pa点"
  }
}
```

### 2.2 获取挑战随机数

**POST /api/challenge**

获取登录挑战随机数。

**请求参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| username | string | 是 | 用户名 |

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| challenge | string | 挑战随机数（Base64 编码） |

### 2.3 用户登录

**POST /api/login**

用户登录并获取访问 Token。

**请求参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| signature | string | 是 | 挑战签名（Base64 编码） |

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| token | string | 访问令牌 |
| userId | string | 用户ID |
| expiresAt | string | 过期时间（ISO 8601 格式） |

### 2.4 用户登出

**POST /api/logout**

用户登出，使当前 Token 失效。

**认证要求**：需要 Bearer Token

### 2.5 初始化密钥生成

**POST /api/key/init**

初始化密钥生成，返回 P2 和 Pa。

**认证要求**：需要 Bearer Token

**请求参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| p1 | string | 是 | 客户端生成的 P1 点（Base64 编码） |

**响应数据**：同注册响应

### 2.6 确认密钥生成

**POST /api/key/confirm**

确认密钥生成完成。

**认证要求**：需要 Bearer Token

### 2.7 协同签名

**POST /api/sign**

执行协同签名操作。

**认证要求**：需要 Bearer Token

**请求参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| q1 | string | 是 | 客户端生成的 Q1 点（Base64 编码） |
| e | string | 是 | 消息哈希 E（Base64 编码） |

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| r | string | 签名分量 r（Base64 编码） |
| s2 | string | 签名分量 s2（Base64 编码） |
| s3 | string | 签名分量 s3（Base64 编码） |

### 2.8 协同解密

**POST /api/decrypt**

执行协同解密操作。

**认证要求**：需要 Bearer Token

**请求参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| t1 | string | 是 | 客户端生成的 T1 点（Base64 编码） |

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| t2 | string | 服务端生成的 T2 点（Base64 编码） |

### 2.9 获取用户信息

**GET /api/user/info**

获取当前登录用户的信息。

**认证要求**：需要 Bearer Token

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | string | 用户ID |
| username | string | 用户名 |
| publicKey | string | 协同公钥 Pa |
| status | integer | 状态：1=启用，0=禁用 |
| createdAt | string | 创建时间 |

## 3. 管理接口

### 3.1 用户管理

#### 3.1.1 获取用户列表

**GET /mapi/users**

获取所有用户的列表。

**认证要求**：需要 Bearer Token

**响应数据**：用户列表

#### 3.1.2 获取用户详情

**GET /mapi/users/{id}**

获取指定用户的详细信息。

**认证要求**：需要 Bearer Token

**路径参数**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | string | 用户ID |

**响应数据**：用户详情

#### 3.1.3 删除用户

**DELETE /mapi/users/{id}**

删除指定用户。

**认证要求**：需要 Bearer Token

**路径参数**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | string | 用户ID |

#### 3.1.4 更新用户状态

**PUT /mapi/users/{id}/status**

更新指定用户的状态。

**认证要求**：需要 Bearer Token

**路径参数**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | string | 用户ID |

**请求参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| status | integer | 是 | 状态：1=启用，0=禁用 |

### 3.2 密钥管理

#### 3.2.1 获取密钥列表

**GET /mapi/keys**

获取所有密钥的列表。

**认证要求**：需要 Bearer Token

**响应数据**：密钥列表

#### 3.2.2 删除密钥

**DELETE /mapi/keys/{id}**

删除指定密钥。

**认证要求**：需要 Bearer Token

**路径参数**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | string | 密钥ID |

### 3.3 审计日志

#### 3.3.1 查询审计日志

**GET /mapi/logs**

查询系统审计日志。

**认证要求**：需要 Bearer Token

**查询参数**

| 字段名 | 类型 | 必填 | 描述 |
|-------|------|------|------|
| userId | string | 否 | 用户ID |
| action | string | 否 | 操作类型 |
| limit | integer | 否 | 日志数量限制（默认100） |

**响应数据**：日志列表

### 3.4 系统管理

#### 3.4.1 健康检查

**GET /mapi/health**

检查服务健康状态。

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| status | string | 服务状态 |
| timestamp | string | 检查时间 |

#### 3.4.2 系统统计

**GET /mapi/stats**

获取系统统计信息。

**认证要求**：需要 Bearer Token

**响应数据**

| 字段名 | 类型 | 描述 |
|-------|------|------|
| userCount | integer | 用户数量 |
| keyCount | integer | 密钥数量 |
| activeSessions | integer | 活跃会话数 |
| uptime | string | 服务运行时间 |

## 4. 错误码

| 错误码 | 描述 |
|-------|------|
| 10001 | 用户名已存在 |
| 10002 | 用户名或密码错误 |
| 10003 | Token 无效或已过期 |
| 10004 | 权限不足 |
| 10005 | 参数错误 |
| 10006 | 密钥生成失败 |
| 10007 | 签名失败 |
| 10008 | 解密失败 |
| 10009 | 内部服务器错误 |

## 5. 示例流程

### 5.1 用户注册和密钥初始化流程

1. 客户端生成 d1，计算 P1 = d1 * G
2. 客户端调用 `/api/register` 接口，发送 username、password 和 P1
3. 服务端生成 d2，计算 d2Inv = d2^(-1) mod n，P2 = d2Inv * G，Pa = d2Inv * P1 + (n-1) * G
4. 服务端存储 (d2, d2Inv, Pa)，返回 (userId, P2, Pa)
5. 客户端计算完整私钥 d = d1 * d2 - 1

### 5.2 协同签名流程

1. 客户端准备消息，计算哈希 E
2. 客户端生成随机数 k1，计算 Q1 = k1 * G
3. 客户端调用 `/api/sign` 接口，发送 Q1 和 E
4. 服务端生成随机数 (k2, k3)
5. 服务端计算 Q2 = k2 * G, x1 = k3 * Q1 + Q2
6. 服务端计算 r = E + x1 mod n
7. 服务端计算 s2 = d2 * k3 mod n, s3 = d2 * (r + k2) mod n
8. 服务端返回 (r, s2, s3)
9. 客户端计算 s1 = k1 * s3 - r * d1 mod n
10. 客户端计算 s = s1 * s2 mod n
11. 最终签名为 (r, s)

### 5.3 协同解密流程

1. 客户端获取密文 C1||C3||C2
2. 客户端计算 T1 = d1 * C1
3. 客户端调用 `/api/decrypt` 接口，发送 T1
4. 服务端计算 T2 = d2Inv * T1
5. 服务端返回 T2
6. 客户端计算共享密钥 K = SM3(T2)
7. 客户端使用 K 解密 C2 获取明文
